@model SoftinnBookingSystem.Models.AssignDrivers
@{
    ViewBag.Title = "AssignDrivers";
}

<style>
    .user-column {
        float: left;
        margin-right: 20px;
        border: 1px solid transparent;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

        .user-column ul {
            list-style-type: none;
            padding: 0;
        }

            .user-column ul li {
                margin-bottom: 5px;
                cursor: pointer;
            }

                .user-column ul li:hover {
                    background-color: #f0f0f0;
                }
</style>

<div class="row">
    <div class="col-sm-12">
        <div class="page-header">
            <h5 class="page-title" style="display: inline;">🚛 Assign Drivers</h5>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<br />
<br />

<h6>Drag and drop the drivers to assign them to the dispatchers.</h6>
<p>Unassigned Drivers: <span id="unassigned-count"></span></p>

@using (Html.BeginForm("AssignDrivers", "Drivers", FormMethod.Post))
{
    <div class="row">
        <div class="col-md-3">
            <h3>Drivers</h3>
            <div id="drivers-list" class="list-items">
                @foreach (var driver in Model.Drivers)
                {
                    <div data-driverid="@driver.DriverID" class="cursor-pointer m-2 p-2 draggable-item bg-danger text-white text-left">
                        <div class="item-content">
                            <div><strong>Driver:</strong></div>
                            <div><span><i class="fa-truck mr-2"></i>@driver.DriverName</span> <i class="ion-arrow-move icon-move"></i></div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="col-md-9" style="overflow-x: auto; white-space: nowrap; display: flex;">
            @foreach (var user in Model.Users)
            {
                <div class="col-md-3">
                    <div data-userid="@user.UserID" class="user-column droppable">
                        <h4 class="user-header">
                            @user.UserName
                            <span class="badge badge-danger item-count">0</span>
                        </h4>
                        <ul class="user-list connectedSortable"></ul>
                    </div>
                </div>
            }
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Save Assignments</button>
}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

@section scripts {
    <script>
    $(document).ready(function () {
        // Function to handle form submission
        $("form").submit(function (event) {
            // Prevent the default form submission
            event.preventDefault();

            // Get the selected driver IDs
            var driverIds = [];
            $(".user-list").each(function () {
                var userId = $(this).closest(".user-column").data("userid");
                $(this).find("li").each(function () {
                    var driverId = $(this).data("driverid");
                    driverIds.push(driverId);
                });
            });

            // Get the user ID (assuming all users have the same ID)
            var userId = $(".user-column").first().data("userid");

            $.ajax({
                url: "/Drivers/AssignDrivers",
                type: "POST",
                data: { driverIds: driverIds, userId: userId },
                success: function (response) {
                    if (response.success) {
                        // Handle success response
                        alert("Assignments saved successfully!");
                    } else {
                        // Handle error response
                        alert("Error: " + response.errorMessage);
                    }
                },
                error: function () {
                    // Handle AJAX error
                    alert("An error occurred while saving assignments.");
                }
            });
        });

        // Function to update the count of items in each user's column
        function updateItemCount() {
            $('.user-column').each(function () {
                var itemCount = $(this).find('.user-list li').length;
                $(this).find('.item-count').text(itemCount);
            });
        }

        // Call the function initially
        updateItemCount();

        // Function to update the count of unassigned drivers
        function updateUnassignedCount() {
            var unassignedCount = $("#drivers-list .draggable-item").length;
            $("#unassigned-count").text(unassignedCount);
        }

        // Call the function initially
        updateUnassignedCount();

        // Initialize draggable items
        $(".draggable-item").draggable({
            helper: "clone",
            cursor: "move",
            start: function (event, ui) {
                $(this).addClass('dragging');
            },
            stop: function (event, ui) {
                $(this).removeClass('dragging').show();
                updateItemCount();
                updateUnassignedCount();
            },
            drag: function (event, ui) {
                // Check if the mouse cursor is near the right edge of the viewport
                var mouseX = event.clientX;
                var viewportWidth = $(window).width();
                var scrollLeft = $(window).scrollLeft();
                if (mouseX > (viewportWidth - 100)) { // Adjust the threshold as needed
                    // Scroll the page horizontally to the right
                    $(window).scrollLeft(scrollLeft + 10); // Adjust the scroll amount as needed
                }
            }
        });

        // Initialize droppable user columns...........
        $(".user-column").droppable({
            accept: ".draggable-item",
            drop: function (event, ui) {
                var draggedDriver = $(ui.draggable).data("driverid");
                var targetUser = $(this).data("userid");
                var currentColumnUser = $(ui.draggable).closest(".user-column").data("userid");

                // Only move the item if it's being dragged to a different user column
                if (currentColumnUser !== targetUser) {
                    ui.draggable.appendTo($(this).find(".user-list")).show();
                    updateItemCount();
                    updateUnassignedCount();
                } else {
                    ui.draggable.show();
                }
            }
        });

        // Initialize droppable drivers list......
        $("#drivers-list").droppable({
            accept: ".draggable-item",
            drop: function (event, ui) {
                ui.draggable.removeClass('dragging').appendTo($(this)).show();
                updateItemCount();
                updateUnassignedCount();
            }
        });
    });
</script>



}
